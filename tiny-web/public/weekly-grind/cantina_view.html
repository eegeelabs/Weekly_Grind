<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Weekly Grind — View</title>
<style>
:root{--bg:#0f1220;--card:#171a2b;--muted:#8892b0;--text:#e6e9ff;--soft:rgba(255,255,255,.08)}
*{box-sizing:border-box}body{margin:0;font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f1220;color:var(--text)}
header{position:sticky;top:0;z-index:5;background:rgba(15,18,32,.9);border-bottom:1px solid var(--soft)}
.wrap{max-width:1400px;margin:0 auto;padding:12px 16px}
h1{margin:0;font-size:20px}
select{background:#0d1224;border:1px solid var(--soft);color:var(--text);border-radius:10px;padding:6px 10px}
main{padding:18px}.table-wrap{overflow:auto;border:1px solid var(--soft);border-radius:14px;background:#171a2b}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
thead th{position:sticky;top:0;background:#1a1e33;color:#cbd5ff;border-bottom:1px solid var(--soft);font-weight:600;text-align:center}
th,td{padding:8px 10px;border-right:1px solid rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.05);vertical-align:top}
th:last-child,td:last-child{border-right:0}.sticky-left{position:sticky;left:0;background:#1a1e33;color:#e6e9ff;font-weight:600;z-index:3}
tbody .sticky-left{background:#151a2c;z-index:2}
/* Cell layout tweaks */
.cell{display:grid;grid-template-rows:auto auto auto;gap:6px;min-height:140px}
.row{display:grid;grid-template-columns:max-content 1fr;gap:6px;align-items:center}
.tag{display:inline-flex;align-items:center;justify-content:center;border-radius:8px;background:#0b1020;border:1px solid var(--soft);font-weight:700;padding:4px 10px;white-space:nowrap}
.text{background:#0d1224;border:1px solid var(--soft);color:#e6e9ff;border-radius:8px;padding:6px 8px}
.notes{grid-column:1 / -1}
.muted{color:#8892b0}
</style>
</head><body>
<header><div class="wrap" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
  <h1>Configuration Cantina — Weekly Grid</h1><div style="flex:1"></div>
  <label>Week: <select id="week"></select></label>
  <a href="/weekly-grind/admin" style="margin-left:8px">Admin</a>
</div></header>
<main class="wrap">
  <div class="table-wrap"><table><thead><tr id="head"></tr></thead><tbody id="body"></tbody></table></div>
  <div id="meta" class="muted" style="margin-top:8px">&nbsp;</div>
</main>
<script>
/* ---------- helpers ---------- */
var head=document.querySelector('#head'), body=document.querySelector('#body'),
    week=document.querySelector('#week'), meta=document.querySelector('#meta');

function esc(s){ s = (s==null?'':String(s)); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function isoLocal(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
function mondayLocal(d){ var x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); var w=x.getDay(); x.setDate(x.getDate()+(w===0?-6:1-w)); return x; }
function dayLabels(monISO){
  var p=monISO.split('-').map(Number), base=new Date(p[0],p[1]-1,p[2]);
  var out=[], i, x, lbl;
  for(i=0;i<5;i++){
    x=addDays(base,i);
    lbl=x.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'2-digit'});
    out.push({iso: isoLocal(x), label: lbl});
  }
  return out;
}

/* robust CSV parse + normalize (slot->Number, fields trimmed) */
function parseCSV(t){
  var r=[], i=0, f='', row=[], qq=false, c;
  while(i<t.length){
    c=t[i];
    if(qq){
      if(c=='"' && t[i+1]=='"'){ f+='"'; i+=2; continue; }
      if(c=='"'){ qq=false; i++; continue; }
      f+=c; i++; continue;
    }
    if(c=='"'){ qq=true; i++; continue; }
    if(c===','){ row.push(f); f=''; i++; continue; }
    if(c==='\n' || c==='\r'){
      if(f!=='' || row.length){ row.push(f); r.push(row); }
      row=[]; f='';
      if(c==='\r' && t[i+1]==='\n') i++;
      i++; continue;
    }
    f+=c; i++;
  }
  if(f!=='' || row.length){ row.push(f); r.push(row); }
  return r.filter(function(a){ return a.length && !(a.length===1 && a[0]===''); });
}

function normalize(rows){
  function trim(v){ return String(v==null?'':v).replace(/[\r\n]+/g,'').trim(); }
  var h=rows[0].map(function(s){return trim(s);});
  function ix(a){ return h.indexOf(a); }
  var I={week_start:ix('week_start'),tech:ix('tech'),day:ix('day'),slot:ix('slot'),type:ix('type'),details:ix('details'),notes:ix('notes'),status:ix('status')};
  if([I.week_start,I.tech,I.day,I.slot,I.type,I.details,I.notes,I.status].some(function(i){return i<0;})) return {rows:[]};
  var out = rows.slice(1).map(function(r){
    return {
      week_start: trim(r[I.week_start]),
      tech:       trim(r[I.tech]),
      day:        trim(r[I.day]),
      slot:       parseInt(trim(r[I.slot]||'0'),10)||0,
      type:       trim(r[I.type]||''),
      details:    trim(r[I.details]||''),
      notes:      trim(r[I.notes]||''),
      status:     trim(r[I.status]||'')
    };
  });
  return {rows: out};
}

function fetchTechs(){
  return fetch('/weekly-grind/techs.json',{cache:'no-store'}).then(function(res){
    if(!res.ok) return [];
    return res.json();
  }).then(function(j){
    if(j && Array.isArray(j.techs)) return j.techs;
    return Array.isArray(j) ? j : [];
  }).catch(function(){ return []; });
}

function buildWeeks(){
  var start=mondayLocal(new Date()), opts=[], i, d, v, l;
  for(i=12;i>=-12;i--){
    d=addDays(start,-7*i); v=isoLocal(d);
    l=d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
    opts.push({v:v, l:l});
  }
  week.innerHTML = opts.map(function(o){
    return '<option value="'+o.v+'">'+o.l+'</option>';
  }).join('');
  week.value = isoLocal(start);
}

function load(monISO){
  var url='/weekly-grind/cantina-schedule-'+monISO+'.csv';
  meta.textContent='Loading…';
  Promise.all([fetch(url,{cache:'no-store'}), fetchTechs()]).then(function(arr){
    var res=arr[0], techsJson=arr[1]||[];
    return res.text().then(function(text){
      var norm = normalize(parseCSV(text));
      render(monISO, norm.rows, techsJson, res.headers.get('Last-Modified'));
    });
  });
}

function render(monISO, rows, techsJson, lastMod){
  var days = dayLabels(monISO);
  var fromCSV = rows.map(function(r){ return r.tech; });
  var techsSet = {};
  (Array.isArray(techsJson)?techsJson:[]).concat(fromCSV).forEach(function(t){ if(t) techsSet[t]=1; });
  var techs = Object.keys(techsSet).sort(function(a,b){ return a.localeCompare(b,undefined,{sensitivity:'base'}); });

  // header
  var h = '<th class="sticky-left">Technician</th>';
  for(var i=0;i<days.length;i++){ h += '<th>'+days[i].label+'</th>'; }
  head.innerHTML = h;

  // body
  var b = '';
  for(var ti=0; ti<techs.length; ti++){
    var tech = techs[ti];
    b += '<tr><td class="sticky-left">'+esc(tech)+'</td>';
    for(var di=0; di<days.length; di++){
      var dISO = days[di].iso;
      var s1=null, s2=null, note='';
      for(var k=0;k<rows.length;k++){
        var r=rows[k];
        if(r.tech===tech && r.day===dISO){
          if(r.slot===1) s1=r;
          else if(r.slot===2) s2=r;
          if(r.notes) note=r.notes;
        }
      }
      b += '<td><div class="cell">'
         +   '<div class="row"><div class="tag">'+esc(s1&&s1.type||'')+'</div><div class="text">'+esc(s1&&s1.details||'')+'</div></div>'
         +   '<div class="row"><div class="tag">'+esc(s2&&s2.type||'')+'</div><div class="text">'+esc(s2&&s2.details||'')+'</div></div>'
         +   '<div class="row notes"><div class="text" style="grid-column:1 / -1">'+esc(note)+'</div></div>'
         + '</div></td>';
    }
    b += '</tr>';
  }
  body.innerHTML = b;

  meta.textContent = lastMod ? ('Loaded • Last modified '+ new Date(lastMod).toLocaleString()) : 'Loaded';
}

buildWeeks();
week.addEventListener('change', function(e){ load(e.target.value); });
load(week.value);
</script>
</body></html>
