<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Grind â€“ Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/weekly-grind/js/auth-check.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem 1.5rem 2rem;
      background: #0b1120;
      color: #e5e7eb;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0;
    }
    .meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .controls input,
    .controls select {
      background: #0b1120;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .controls label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn {
      background: #1e40af;
      color: #fff;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn:hover {
      background: #1e3a8a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      position: sticky;
      top: 0;
      background: #0b1120;
      z-index: 1;
    }
    th, td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #111827;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #9ca3af;
      cursor: pointer;
    }
    th.hidden, td.hidden {
      display: none;
    }
    tr:nth-child(even) td {
      background: #0b1120;
    }
    tr:nth-child(odd) td {
      background: #0b1120;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #1f2937;
    }
    .status-open { background: rgba(34,197,94,0.08); border-color: #16a34a; color: #bbf7d0; }
    .status-on_hold { background: rgba(234,179,8,0.08); border-color: #eab308; color: #facc15; }
    .status-complete { background: rgba(59,130,246,0.08); border-color: #3b82f6; color: #bfdbfe; }
    .status-cancelled { background: rgba(148,163,184,0.08); border-color: #6b7280; color: #e5e7eb; }

    .risk-low { color: #22c55e; }
    .risk-medium { color: #eab308; }
    .risk-high { color: #f97316; }
    .risk-critical { color: #ef4444; }

    .tag {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 0.08rem 0.4rem;
      border: 1px solid #1f2937;
    }
    .tag-hot { border-color: #ef4444; color: #fecaca; }
    .tag-warm { border-color: #eab308; color: #fef3c7; }
    .tag-cool { border-color: #22c55e; color: #bbf7d0; }

    .pill {
      padding: 0.08rem 0.35rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .table-container {
      border-radius: 0.5rem;
      border: 1px solid #111827;
      overflow: auto;
      max-height: calc(100vh - 150px);
      background: #0b1120;
    }

    .error {
      color: #fecaca;
      background: rgba(248,113,113,0.1);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #fecaca33;
      margin-bottom: 0.75rem;
      font-size: 0.8rem;
    }
    .loading {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.75rem;
    }

    /* Column Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #111827;
      border-radius: 0.5rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      border: 1px solid #1f2937;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #e5e7eb;
    }
    .column-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .column-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #0f172a;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .column-item:hover {
      background: #111827;
    }
    .column-item input[type="checkbox"] {
      cursor: pointer;
    }
    .column-item label {
      cursor: pointer;
      flex: 1;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    .modal-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .btn-secondary {
      background: #475569;
      color: #fff;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-secondary:hover {
      background: #1f2937;
    }
  
    /* Unified Header - Everything in One Section */
    header {
      background: #1a2332;
      padding: 1rem 1.5rem;
      border-bottom: 2px solid #2a3a52;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .unified-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 2rem;
    }

    .header-content {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #e5e7eb;
      margin: 0;
    }

    /* Profile Section - Far Right */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    .user-info-text {
      font-size: 1rem;
      color: #94a3b8;
      font-weight: 500;
      white-space: nowrap;
    }

    .small-profile-icon {
      width: 40px;
      height: 40px;
      background-color: #3498db;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }

        .profile-group {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1rem;
    }

    

    

    .logout-btn {
      background: #4a5568;
      color: #e5e7eb;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: #5a6778;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

  
    /* Unified Navigation Styles */
    .wg-main-nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .wg-nav-link {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #2a3a52;
      background: #1a2332;
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s;
    }

    .wg-nav-link:hover {
      border-color: #4f46e5;
      background: #111827;
      color: #e5e7eb;
    }

    .wg-nav-link.active {
      background: #4f46e5;
      border-color: #4f46e5;
      color: #fff;
      font-weight: 500;
    }

  </style>
</head>
<body>
 <header>
    <div class="unified-header">
      <div class="header-content">
        <div class="header-row">
          <strong class="header-title">Weekly Grind - Projects</strong>
          <div class="meta" id="meta-summary" style="margin-left: 1rem; font-size: 0.85rem;">Loading projectsâ€¦</div>
        </div>
        
        <div class="header-row">
          <nav class="wg-main-nav">
            <a href="/weekly-grind/view" class="wg-nav-link">Schedule View</a>
            <a href="/weekly-grind/projects" class="wg-nav-link active">Projects</a>
            <a href="/weekly-grind/repair-reimage" class="wg-nav-link">Repair & Reimage</a>
            <a href="/weekly-grind/decom-checkin" class="wg-nav-link">Equipment Check-In</a>
            <a href="/weekly-grind/scheduling" class="wg-nav-link">Scheduling</a>
            <a href="/weekly-grind/supervisor-dashboard" class="wg-nav-link dashboard-link" data-roles="supervisor">Supervisor Dashboard</a>
            <a href="/weekly-grind/manager-dashboard" class="wg-nav-link dashboard-link" data-roles="manager">Manager Dashboard</a>
            <a href="/weekly-grind/admin-options" class="wg-nav-link admin-link">Admin Options</a>
          </nav>
        </div>
      </div>

      <div class="profile-section">
        <span class="user-info-text" id="userInfoRight">Loading...</span>
        <div class="small-profile-icon" id="smallAvatar">ðŸ‘¤</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <!-- Action Buttons -->
  <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1rem;">
    <a id="newProjectBtn" href="/weekly-grind/projects/new" class="btn" style="text-decoration: none;">+ New Project</a>
  </div>

  <div class="controls">
    <label>
      Search:
      <input type="text" id="searchBox" placeholder="PID, client, nameâ€¦" />
    </label>
    <label>
      Status:
      <select id="statusFilter">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="on_hold">On Hold</option>
        <option value="complete">Complete</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </label>
    <button class="btn" id="btnColumns">âš™ Columns</button>
  </div>

  <div id="messages"></div>

  <div class="table-container">
    <table id="projectsTable">
      <thead>
        <tr>
          <th data-sort="pid" data-column="pid">PID</th>
          <th data-sort="client_id" data-column="client">Client</th>
          <th data-sort="project_name" data-column="project_name">Project</th>
          <th data-sort="status" data-column="status">Status</th>
          <th data-sort="days_open" data-column="days_open">Days Open</th>
          <th data-sort="days_past_config_goal" data-column="cfg_delta">Cfg Î”</th>
          <th data-sort="days_past_project_goal" data-column="proj_delta">Proj Î”</th>
          <th data-sort="customer_temp" data-column="temp">Temp</th>
          <th data-sort="date_project_opened" data-column="opened">Opened</th>
          <th data-sort="date_hardware_received" data-column="hw_recv">HW Recv</th>
          <th data-sort="date_last_contacted" data-column="last_contact">Last Contact</th>
          <th data-column="stp_link">STP</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows injected by JS -->
      </tbody>
    </table>
  </div>

  <!-- Column Visibility Modal -->
  <div id="columnModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Show/Hide Columns</div>
      <div class="column-list" id="columnList">
        <!-- Generated by JS -->
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" id="btnResetColumns">Reset to Default</button>
        <button class="btn" id="btnSaveColumns">Save</button>
      </div>
    </div>
  </div>

  <script>
    const apiUrl = '/api/projects';
    let allProjects = [];
    let currentSort = { key: 'date_project_opened', dir: 'desc' };

    // Column definitions
    const COLUMNS = [
      { id: 'pid', label: 'PID', default: true, required: true },
      { id: 'client', label: 'Client', default: true },
      { id: 'project_name', label: 'Project', default: true, required: true },
      { id: 'status', label: 'Status', default: true },
      { id: 'days_open', label: 'Days Open', default: true },
      { id: 'cfg_delta', label: 'Config Î”', default: true },
      { id: 'proj_delta', label: 'Project Î”', default: true },
      { id: 'temp', label: 'Temperature', default: false },
      { id: 'opened', label: 'Date Opened', default: true },
      { id: 'hw_recv', label: 'HW Received', default: false },
      { id: 'last_contact', label: 'Last Contact', default: false },
      { id: 'stp_link', label: 'STP Link', default: true }
    ];

    // Load column preferences from localStorage
    function loadColumnPreferences() {
      const saved = localStorage.getItem('projectColumns');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.error('Error parsing column preferences:', e);
        }
      }
      // Return default columns
      return COLUMNS.filter(c => c.default).map(c => c.id);
    }

    // Save column preferences to localStorage
    function saveColumnPreferences(visibleColumns) {
      localStorage.setItem('projectColumns', JSON.stringify(visibleColumns));
    }

    // Apply column visibility
    function applyColumnVisibility(visibleColumns) {
      COLUMNS.forEach(col => {
        const isVisible = visibleColumns.includes(col.id);
        const headers = document.querySelectorAll(`th[data-column="${col.id}"]`);
        const cells = document.querySelectorAll(`td[data-column="${col.id}"]`);
        
        headers.forEach(th => {
          if (isVisible) {
            th.classList.remove('hidden');
          } else {
            th.classList.add('hidden');
          }
        });
        
        cells.forEach(td => {
          if (isVisible) {
            td.classList.remove('hidden');
          } else {
            td.classList.add('hidden');
          }
        });
      });
    }

    // Open column modal
    function openColumnModal() {
      const modal = document.getElementById('columnModal');
      const columnList = document.getElementById('columnList');
      columnList.innerHTML = '';

      const visibleColumns = loadColumnPreferences();

      COLUMNS.forEach(col => {
        const item = document.createElement('div');
        item.className = 'column-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `col-${col.id}`;
        checkbox.checked = visibleColumns.includes(col.id);
        checkbox.disabled = col.required;
        
        const label = document.createElement('label');
        label.htmlFor = `col-${col.id}`;
        label.textContent = col.label + (col.required ? ' (required)' : '');
        
        // Only add click handler to label, not the whole item
        label.onclick = (e) => {
          e.preventDefault();
          if (!col.required) {
            checkbox.checked = !checkbox.checked;
          }
        };
        
        // Let checkbox handle its own clicks
        checkbox.onclick = (e) => {
          e.stopPropagation();
        };
        
        item.appendChild(checkbox);
        item.appendChild(label);
        columnList.appendChild(item);
      });

      modal.style.display = 'flex';
    }

    // Close column modal
    function closeColumnModal() {
      document.getElementById('columnModal').style.display = 'none';
    }

    // Save column selections
    function saveColumnSelections() {
      const visibleColumns = [];
      COLUMNS.forEach(col => {
        const checkbox = document.getElementById(`col-${col.id}`);
        if (checkbox && checkbox.checked) {
          visibleColumns.push(col.id);
        }
      });
      
      saveColumnPreferences(visibleColumns);
      applyColumnVisibility(visibleColumns);
      closeColumnModal();
    }

    // Reset to default columns
    function resetColumns() {
      const defaultColumns = COLUMNS.filter(c => c.default).map(c => c.id);
      saveColumnPreferences(defaultColumns);
      applyColumnVisibility(defaultColumns);
      
      // Update checkboxes
      COLUMNS.forEach(col => {
        const checkbox = document.getElementById(`col-${col.id}`);
        if (checkbox) {
          checkbox.checked = defaultColumns.includes(col.id);
        }
      });
    }

    function fmtDate(d) {
      if (!d) return '';
      return String(d).slice(0, 10);
    }

    function generateStpLink(pid) {
      if (!pid) return '';
      
      // Extract numeric ID from PID
      // Examples: "31409" -> "31409", "ACME-2025-31409" -> "31409", "PROJECT-31409" -> "31409"
      const match = pid.match(/(\d+)$/);
      if (!match) return '';
      
      const numericId = match[1];
      const url = `https://stp.boit.us/projectprofile/${numericId}`;
      
      return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:#93c5fd;text-decoration:none;" title="View in STP">ðŸ”—</a>`;
    }

    function statusClass(status) {
      if (!status) return 'status-pill';
      const s = status.toLowerCase();
      if (s === 'open') return 'status-pill status-open';
      if (s === 'on_hold' || s === 'on hold') return 'status-pill status-on_hold';
      if (s === 'complete' || s === 'completed') return 'status-pill status-complete';
      if (s === 'cancelled' || s === 'canceled') return 'status-pill status-cancelled';
      return 'status-pill';
    }

    function tempTag(temp) {
      if (temp == null) return '';
      const t = Number(temp);
      let cls = 'tag', label = t;
      if (t >= 4) cls += ' tag-hot';
      else if (t === 3) cls += ' tag-warm';
      else cls += ' tag-cool';
      return '<span class="' + cls + '">Temp ' + label + '</span>';
    }

    function riskClass(daysPastGoal) {
      if (daysPastGoal == null) return '';
      const v = Number(daysPastGoal);
      if (isNaN(v)) return '';
      if (v <= 0) return 'risk-low';
      if (v <= 7) return 'risk-medium';
      if (v <= 21) return 'risk-high';
      return 'risk-critical';
    }

    function updateMeta(filteredCount) {
      const meta = document.getElementById('meta-summary');
      const total = allProjects.length;
      if (!total) {
        meta.textContent = 'No projects found.';
        return;
      }
      const openCount = allProjects.filter(p => (p.status || '').toLowerCase() === 'open').length;
      meta.textContent = filteredCount === total
        ? total + ' projects (' + openCount + ' open)'
        : filteredCount + ' of ' + total + ' projects shown (' + openCount + ' open)';
    }

    function renderTable() {
      const tbody = document.querySelector('#projectsTable tbody');
      const search = document.getElementById('searchBox').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value.toLowerCase();

      let rows = allProjects.slice();

      // filter
      rows = rows.filter(p => {
        if (statusFilter && (p.status || '').toLowerCase() !== statusFilter) return false;
        if (search) {
          const blob = [
            p.pid,
            p.client_id,
            p.project_name,
            p.status
          ].join(' ').toLowerCase();
          if (!blob.includes(search)) return false;
        }
        return true;
      });

      // sort
      const { key, dir } = currentSort;
      rows.sort((a, b) => {
        const va = a[key];
        const vb = b[key];
        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;

        const na = Number(va), nb = Number(vb);
        if (!Number.isNaN(na) && !Number.isNaN(nb)) {
          return dir === 'asc' ? na - nb : nb - na;
        }

        const sa = String(va);
        const sb = String(vb);
        if (sa < sb) return dir === 'asc' ? -1 : 1;
        if (sa > sb) return dir === 'asc' ? 1 : -1;
        return 0;
      });

      // render
      const cfgRisk = (p) => riskClass(p.days_past_config_goal);
      const projRisk = (p) => riskClass(p.days_past_project_goal);
      
      tbody.innerHTML = rows.map(p => {
        return `
          <tr>
            <td data-column="pid">
              <a href="/weekly-grind/projects/${encodeURIComponent(p.pid || '')}/edit"
                 style="color:#93c5fd;text-decoration:none;">
                <code>${p.pid || ''}</code>
              </a>
            </td>
            <td data-column="client">${p.client_id || ''}</td>
            <td data-column="project_name">${p.project_name || ''}</td>
            <td data-column="status"><span class="${statusClass(p.status)}">${p.status || 'n/a'}</span></td>
            <td data-column="days_open">${p.days_open != null ? p.days_open : ''}</td>
            <td data-column="cfg_delta" class="${cfgRisk(p)}">${p.days_past_config_goal != null ? p.days_past_config_goal : ''}</td>
            <td data-column="proj_delta" class="${projRisk(p)}">${p.days_past_project_goal != null ? p.days_past_project_goal : ''}</td>
            <td data-column="temp">${tempTag(p.customer_temp)}</td>
            <td data-column="opened">${fmtDate(p.date_project_opened)}</td>
            <td data-column="hw_recv">${fmtDate(p.date_hardware_received)}</td>
            <td data-column="last_contact">${fmtDate(p.date_last_contacted)}</td>
            <td data-column="stp_link">${generateStpLink(p.pid)}</td>
          </tr>
        `;
      }).join('');

      // Apply column visibility after rendering
      applyColumnVisibility(loadColumnPreferences());

      updateMeta(rows.length);
    }

    function attachSortHandlers() {
      document.querySelectorAll('#projectsTable thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort');
          if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.key = key;
            currentSort.dir = 'asc';
          }
          renderTable();
        });
      });
    }

    async function loadProjects() {
      const messages = document.getElementById('messages');
      messages.innerHTML = '<div class="loading">Loading projects from serverâ€¦</div>';
      try {
        const res = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        allProjects = await res.json();
        attachSortHandlers();
        messages.innerHTML = '';
        renderTable();
      } catch (err) {
        console.error('Failed to load projects', err);
        messages.innerHTML = '<div class="error">Failed to load projects. ' +
          'Check the backend logs or try again.</div>';
      }
    }

    function attachFilters() {
      document.getElementById('searchBox').addEventListener('input', () => renderTable());
      document.getElementById('statusFilter').addEventListener('change', () => renderTable());
    }

    // Column modal events
    document.getElementById('btnColumns').addEventListener('click', openColumnModal);
    document.getElementById('btnSaveColumns').addEventListener('click', saveColumnSelections);
    document.getElementById('btnResetColumns').addEventListener('click', resetColumns);
    
    // Close modal when clicking outside
    document.getElementById('columnModal').addEventListener('click', (e) => {
      if (e.target.id === 'columnModal') {
        closeColumnModal();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      attachFilters();
      loadProjects();
      
      // Apply saved column preferences on load
      applyColumnVisibility(loadColumnPreferences());
    });
  
    // Load user info and avatars
    async function loadUserInfo() {
      try {
        const response = await fetch('/auth/me', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          const displayName = user.display_name || user.username;
          const avatar = user.avatar || 'ðŸ‘¤';
          const role = user.role.charAt(0).toUpperCase() + user.role.slice(1);
          const fullName = displayName + ' (' + role + ')';
          
          // Update avatar (small icon only)
          const smallAvatar = document.getElementById('smallAvatar');
          if (smallAvatar) smallAvatar.textContent = avatar;
          
          // Update username (right side only)
          const userInfoRight = document.getElementById('userInfoRight');
          if (userInfoRight) userInfoRight.textContent = fullName;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    async function logout() {
      try {
        await fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/weekly-grind/login';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/weekly-grind/login';
      }
    }

    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadUserInfo);
    } else {
      loadUserInfo();
    }

  
    // Filter navigation based on user role
    async function filterNavigation() {
      try {
        const response = await fetch('/auth/me', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          
          // Hide dashboard links not for this role
          document.querySelectorAll('.dashboard-link').forEach(link => {
            const roles = link.getAttribute('data-roles');
            if (roles && !roles.includes(user.role)) {
              link.style.display = 'none';
            }
          });
          
          // Hide admin options if not admin
          if (!user.is_admin) {
            document.querySelectorAll('.admin-link').forEach(link => {
              link.style.display = 'none';
            });
          }
        }
      } catch (error) {
        console.error('Error filtering navigation:', error);
      }
          
          // Hide New Project button for techs
          const newProjectBtn = document.getElementById('newProjectBtn');
          if (newProjectBtn && user.role === 'tech') {
            newProjectBtn.style.display = 'none';
          }

    }
    
    // Run after page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', filterNavigation);
    } else {
      filterNavigation();
    }

  </script>
</body>
</html>
