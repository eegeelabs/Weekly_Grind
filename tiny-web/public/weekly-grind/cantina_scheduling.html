<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weekly Grind - Scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/weekly-grind/js/auth-check.js"></script>

  <style>
    :root {
  --bg: #0b1120;
  --panel: #111827;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --line: #1f2937;
  --accent: #4f46e5;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
}

    html, body { height:100%; }
    body {
      background: var(--bg);
      color: var(--text);
      margin:0;
      font:14px system-ui, -apple-system, Segoe UI, Arial;
    }

    
    header small.note {
      font-size:12px;
      color:var(--muted);
    }

    #hint { color:var(--muted); }
    #hint.saved {
      color:var(--ok);
      font-weight:600;
    }

    button {
      background:#1b2537;
      border:1px solid #2a3a53;
      color:var(--text);
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
    }

    button.del {
      background:#3a1010;
      border-color:#5c1a1a;
    }

    /* Admin nav */
    .wg-admin-nav {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .wg-nav-link {
      font-size: 0.8rem;
      padding: 0.22rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      text-decoration: none;
    }

    .wg-nav-link:hover {
      border-color: var(--accent);
      background: var(--panel);
    }

    .wg-nav-link.primary {
      background: var(--accent);
      border-color: var(--accent);
      font-weight: 500;
    }

    /* Table */
    table {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }

    th, td {
      border:1px solid var(--line);
      padding:0;
      vertical-align:top;
    }

    th {
      background:#0b1322;
      position:sticky;
      top: 160px; /* adjusted for new header height */
      z-index:5;
      height:40px;
      padding:0;
      text-align:left;
    }

    th .dayhead {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:0 10px;
      height:40px;
    }

    th .dayhead .dmd {
      color: var(--muted);
      font-size:11px;
    }

    /* Technician column */
    th.sticky-left,
    td.sticky-left {
      position:sticky;
      left:0;
      background:#0b1322;
      z-index:6;
      width:150px;
      min-width:150px;
      max-width:150px;
      padding:6px;
    }

    td.sticky-left input {
      width:100%;
      background:#0d1726;
      border:1px solid #2c3a50;
      color:var(--text);
      border-radius:6px;
      padding:4px 6px;
      box-sizing:border-box;
    }

    /* Cell layout */
    .cell {
      padding:6px;
      display:grid;
      gap:6px;
    }

    .row {
      display:grid;
      grid-template-columns: 85px 1fr 22px;
      gap:6px;
      align-items:center;
    }

    .row.notes { grid-template-columns: 1fr; }

    select,
    input[type="text"],
    textarea {
      background:#0d1726;
      border:1px solid #2c3a50;
      color:var(--text);
      border-radius:6px;
      box-sizing:border-box;
    }

    select {
      height:32px;
      padding:0 20px 0 6px;
      min-width:70px;
      width:auto;
    }

    input[type="text"] {
      height:32px;
      padding:0 6px;
    }

    label.done-flag {
      display:flex;
      align-items:center;
      justify-content:flex-end;
    }

    label.done-flag input {
      margin:0;
      transform: translateY(1px);
    }

    textarea.notes {
      width:100%;
      min-height:55px;
      resize:vertical;
      padding:6px;
    }

    tfoot td { padding:8px; }
  
    /* Unified Header - Everything in One Section */
    header {
      background: #1a2332;
      padding: 1rem 1.5rem;
      border-bottom: 2px solid #2a3a52;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .unified-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 2rem;
    }

    .header-content {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #e5e7eb;
      margin: 0;
    }

    .week-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .week-input-group label {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    /* Profile Section - Far Right */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    .user-info-text {
      font-size: 1rem;
      color: #94a3b8;
      font-weight: 500;
      white-space: nowrap;
    }

    .small-profile-icon {
      width: 40px;
      height: 40px;
      background-color: #3498db;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }

    .profile-group {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1rem;
    }

    
    .btn {
      padding: 0.5rem 1.25rem;
      border-radius: 6px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #4338ca;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--line);
    }

    .btn-secondary:hover {
      background: #1f2937;
      border-color: var(--accent);
    }

    .logout-btn {
      background: #4a5568;
      color: #e5e7eb;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: #5a6778;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

  </style>
</head>
<body>
  <header>
    <div class="unified-header">
      <!-- Left: All admin controls -->
      <div class="header-content">
        <div class="header-row">
          <strong class="header-title">Weekly Grind - Scheduling</strong>
          <div class="week-input-group">
            <label>Week (Monday):</label>
            <input id="week" type="date">
          </div>
          <button id="saveBtn">Save to Server</button>
          <span id="hint">Idle</span>
          <small id="lastSaved"></small>
        </div>
        
        <div class="header-row">
          <nav class="wg-main-nav">
            <a href="/weekly-grind/view" class="wg-nav-link">Schedule View</a>
            <a href="/weekly-grind/projects" class="wg-nav-link">Projects</a>
            <a href="/weekly-grind/repair-reimage" class="wg-nav-link">Repair & Reimage</a>
            <a href="/weekly-grind/decom-checkin" class="wg-nav-link">Equipment Check-In</a>
            <a href="/weekly-grind/scheduling" class="wg-nav-link">Scheduling</a>
            <a href="/weekly-grind/supervisor-dashboard" class="wg-nav-link dashboard-link" data-roles="supervisor">Supervisor Dashboard</a>
            <a href="/weekly-grind/manager-dashboard" class="wg-nav-link dashboard-link" data-roles="manager">Manager Dashboard</a>
            <a href="/weekly-grind/admin-options" class="wg-nav-link admin-link">Admin Options</a>
          </nav>
        </div>
        
        <small class="note">To mark completion, check the box to the right of the task.</small>
      </div>

      <!-- Right: Profile section -->
      <div class="profile-section">
        <span class="user-info-text" id="userInfoRight">Loading...</span>
        <div class="small-profile-icon" id="smallAvatar">ðŸ‘¤</div>
        <div class="profile-group">
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <table>
    <thead><tr id="head"></tr></thead>
    <tbody id="body"></tbody>
  </table>

  <script>
    const head=document.getElementById('head');
    const body=document.getElementById('body');
    const week=document.getElementById('week');
    const saveBtn=document.getElementById('saveBtn');
    const hint=document.getElementById('hint');
    const lastSaved=document.getElementById('lastSaved');
    const TYPES=['','IMG','Bypass','Testing','Deploy','PC-O','R/R','Other'];

    const pad2=n=>String(n).padStart(2,'0');
    const toISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    function mondayOf(iso){
      const d=new Date(`${iso}T00:00:00`);
      const w=d.getDay();
      d.setDate(d.getDate()+(w===0?-6:1-w));
      return toISO(d);
    }

    function csvEscape(v){
      if(v==null)v='';
      const s=String(v);
      return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;
    }

    function toCSV(rows){
      return rows.map(r=>r.map(csvEscape).join(',')).join('\n')+'\n';
    }

    function parseCSV(text){
      let rows=[],i=0,field='',inQ=false,row=[];
      const push=()=>{row.push(field);field='';};
      const end=()=>{rows.push(row);row=[];};
      while(i<text.length){
        const ch=text[i++];
        if(inQ){
          if(ch=='"'){
            if(text[i]=='"'){field+='"';i++;}
            else inQ=false;
          }else field+=ch;
        }else{
          if(ch=='"')inQ=true;
          else if(ch==',')push();
          else if(ch=='\n'){push();end();}
          else if(ch!='\r')field+=ch;
        }
      }
      if(field.length||row.length){push();end();}
      return rows;
    }

    function normalize(rows){
      const head=rows[0]||[];
      const idx={};
      ['week_start','tech','day','slot','type','details','notes','status'].forEach(
        k=>idx[k]=head.indexOf(k)
      );
      const out=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        if(!r||!r.length)continue;
        out.push({
          week_start:r[idx.week_start]||'',
          tech:r[idx.tech]||'',
          day:r[idx.day]||'',
          slot:r[idx.slot]||'',
          type:r[idx.type]||'',
          details:r[idx.details]||'',
          notes:r[idx.notes]||'',
          status:r[idx.status]||''
        });
      }
      return out;
    }

    async function fetchTechs(){
      try{
        const r=await fetch('/api/users?for_assignment=true',{cache:'no-store'});
        const users=await r.json();
        // Extract just usernames from user objects
        return users.map(u => u.username);
      }catch{
        return[];
      }
    }

    function dayLabels(mon){
      const d=new Date(`${mon}T00:00:00`);
      const names=['Mon','Tue','Wed','Thu','Fri'];
      const out=[];
      for(let i=0;i<5;i++){
        const dd=new Date(d);
        dd.setDate(d.getDate()+i);
        out.push({iso:toISO(dd),label:names[i]});
      }
      return out;
    }

    let DAYS=[],TECHS=[];

    function renderHeader(){
      const parts = ['<th class="sticky-left">Technician</th>'];
      DAYS.forEach(d=>{
        const md = d.iso.slice(5).replace('-','/');
        parts.push(
          `<th data-iso="${d.iso}"><div class="dayhead"><span class="dlabel">${d.label}</span><span class="dmd">${md}</span></div></th>`
        );
      });
      head.innerHTML = parts.join('');
    }

    function renderRow(tech,rows){
      const tr=document.createElement('tr');
      tr.innerHTML=
        `<td class="sticky-left"><input value="${tech}"> <button class="del">Del</button></td>`;
      tr.querySelector('.del').onclick=()=>{
        if(confirm('Remove technician row?'))tr.remove();
      };

      DAYS.forEach(d=>{
        const r1=rows.find(r=>r.tech===tech&&r.day===d.iso&&r.slot=='1')||{};
        const r2=rows.find(r=>r.tech===tech&&r.day===d.iso&&r.slot=='2')||{};
        const s1=/^(y|1|true)$/i.test(r1.status||'')?'checked':'';
        const s2=/^(y|1|true)$/i.test(r2.status||'')?'checked':'';

        const td=document.createElement('td');
        td.innerHTML=
          `<div class="cell">
             <div class="row">
               <select class="s1t">
                 ${TYPES.map(o=>`<option${o===r1.type?' selected':''}>${o}</option>`).join('')}
               </select>
               <input class="s1p" type="text" value="${(r1.details||'').replace(/"/g,'&quot;')}">
               <label class="done-flag"><input type="checkbox" class="s1done" ${s1}></label>
             </div>
             <div class="row">
               <select class="s2t">
                 ${TYPES.map(o=>`<option${o===r2.type?' selected':''}>${o}</option>`).join('')}
               </select>
               <input class="s2p" type="text" value="${(r2.details||'').replace(/"/g,'&quot;')}">
               <label class="done-flag"><input type="checkbox" class="s2done" ${s2}></label>
             </div>
             <div class="row notes">
               <textarea class="notes">${(r1.notes||r2.notes||'')}</textarea>
             </div>
           </div>`;
        tr.appendChild(td);
      });

      body.appendChild(tr);
    }

    async function load(mon){
      hint.textContent='Loadingï¿½';
      const resp=await fetch(`/weekly-grind/cantina-schedule-${mon}.csv`,{cache:'no-store'});
      const text=await resp.text();
      const rows=normalize(parseCSV(text));

      TECHS=(await fetchTechs()).slice();
      rows.forEach(r=>{
        if(r.tech&&!TECHS.includes(r.tech))TECHS.push(r.tech);
      });
      TECHS.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

      DAYS=dayLabels(mon);
      renderHeader();
      body.innerHTML='';

      TECHS.forEach(t=>renderRow(t,rows));

      const fr=document.createElement('tr');
      const fd=document.createElement('td');
      fd.colSpan=6;
      fd.innerHTML='<button id="addTech">Add Tech</button> <button id="saveBtn2">Save to Server</button>';
      fr.appendChild(fd);
      body.appendChild(fr);

      document.getElementById('addTech').onclick=()=>{
        const name=(prompt('Technician name:')||'').trim();
        if(!name)return;
        if(!TECHS.includes(name))TECHS.push(name);
        renderRow(name,[]);
      };

      document.getElementById('saveBtn2').onclick=saveNow;
      hint.textContent='Ready';
    }

    function dayIsoFromIndex(i){
      const th=head.querySelector(`th:nth-child(${i+2})`);
      return th?th.dataset.iso:'';
    }

    function gather(mon){
      const out=[["week_start","tech","day","slot","type","details","notes","status"]];
      const trs=[...body.querySelectorAll('tr')].filter(tr=>tr.querySelector('.del'));

      trs.forEach(tr=>{
        const tech=tr.querySelector('.sticky-left input')?.value?.trim()||'';
        if(!tech)return;
        const tds=tr.querySelectorAll('td');
        for(let i=1;i<tds.length;i++){
          const td=tds[i];
          const day=dayIsoFromIndex(i-1);
          const notes=td.querySelector('.notes')?.value||'';
          [
            ["s1t","s1p","s1done","1"],
            ["s2t","s2p","s2done","2"]
          ].forEach(([t,p,c,slot])=>{
            const type=td.querySelector('.'+t)?.value||'';
            const det=td.querySelector('.'+p)?.value||'';
            const done=td.querySelector('.'+c)?.checked?'Y':'';
            out.push([mon,tech,day,slot,type,det,notes,done]);
          });
        }
      });
      return out;
    }

    async function saveNow(){
      const mon=week.value;
      if(!mon){
        alert('Select a week');
        return;
      }
      const csv=toCSV(gather(mon));
      hint.textContent='Savingï¿½';
      try{
        let r=await fetch('/weekly-grind/api/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({mondayISO:mon,csv})
        });
        if(r.ok){
          hint.textContent='Saved';
          hint.classList.add('saved');
          lastSaved.textContent='Last saved: '+new Date().toLocaleString();
        }else{
          hint.textContent='Save failed';
        }
      }catch(e){
        hint.textContent='Save failed';
      }
    }

    const todayISO=toISO(new Date());
    const monISO=mondayOf(todayISO);
    week.value=monISO;
    week.addEventListener('change',e=>load(e.target.value));
    saveBtn.addEventListener('click',saveNow);
    load(monISO);

    // Load user info and avatars
    async function loadUserInfo() {
      try {
        const response = await fetch('/auth/me', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          const displayName = user.display_name || user.username;
          const avatar = user.avatar || 'ðŸ‘¤';
          const role = user.role.charAt(0).toUpperCase() + user.role.slice(1);
          const fullName = displayName + ' (' + role + ')';
          
          // Update all avatar displays
          const leftAvatar = document.getElementById('leftAvatar');
          const profileAvatar = document.getElementById('profileAvatar');
          if (leftAvatar) leftAvatar.textContent = avatar;
          if (profileAvatar) profileAvatar.textContent = avatar;
          
          // Update user name/role displays
          const userName = document.getElementById('userName');
          const userInfoRight = document.getElementById('userInfoRight');
          if (userName) userName.textContent = fullName;
          if (userInfoRight) userInfoRight.textContent = fullName;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    async function logout() {
      try {
        await fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/weekly-grind/login';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/weekly-grind/login';
      }
    }

    // Load user info on page load
    loadUserInfo();
  
    // Filter navigation based on user role
    async function filterNavigation() {
      try {
        const response = await fetch('/auth/me', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          
          // Hide dashboard links not for this role
          document.querySelectorAll('.dashboard-link').forEach(link => {
            const roles = link.getAttribute('data-roles');
            if (roles && !roles.includes(user.role)) {
              link.style.display = 'none';
            }
          });
          
          // Hide admin options if not admin
          if (!user.is_admin) {
            document.querySelectorAll('.admin-link').forEach(link => {
              link.style.display = 'none';
            });
          }
        }
      } catch (error) {
        console.error('Error filtering navigation:', error);
      }
    }
    
    // Run after page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', filterNavigation);
    } else {
      filterNavigation();
    }

  </script>
</body>
</ht