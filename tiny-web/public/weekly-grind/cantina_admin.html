<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weekly Grind Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0f1520;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --line: #1f2937;
      --ok: #10b981;
      --accent: #4f46e5;
    }

    html, body { height:100%; }
    body {
      background: var(--bg);
      color: var(--text);
      margin:0;
      font:14px system-ui, -apple-system, Segoe UI, Arial;
    }

    /* Header */
    header {
      background: var(--panel);
      padding:10px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    header .topline {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    header small.note {
      font-size:12px;
      color:var(--muted);
    }

    #hint { color:var(--muted); }
    #hint.saved {
      color:var(--ok);
      font-weight:600;
    }

    button {
      background:#1b2537;
      border:1px solid #2a3a53;
      color:var(--text);
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
    }

    button.del {
      background:#3a1010;
      border-color:#5c1a1a;
    }

    /* Admin nav */
    .wg-admin-nav {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .wg-nav-link {
      font-size: 0.8rem;
      padding: 0.22rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      text-decoration: none;
    }

    .wg-nav-link:hover {
      border-color: var(--accent);
      background: var(--panel);
    }

    /* Table */
    table {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }

    th, td {
      border:1px solid var(--line);
      padding:0;
      vertical-align:top;
    }

    th {
      background:#0b1322;
      position:sticky;
      top:78px; /* adjust if header height changes */
      z-index:5;
      height:40px;
      padding:0;
      text-align:left;
    }

    th .dayhead {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:0 10px;
      height:40px;
    }

    th .dayhead .dmd {
      color: var(--muted);
      font-size:11px;
    }

    /* Technician column */
    th.sticky-left,
    td.sticky-left {
      position:sticky;
      left:0;
      background:#0b1322;
      z-index:6;
      width:150px;
      min-width:150px;
      max-width:150px;
      padding:6px;
    }

    td.sticky-left input {
      width:100%;
      background:#0d1726;
      border:1px solid #2c3a50;
      color:var(--text);
      border-radius:6px;
      padding:4px 6px;
      box-sizing:border-box;
    }

    /* Cell layout */
    .cell {
      padding:6px;
      display:grid;
      gap:6px;
    }

    .row {
      display:grid;
      grid-template-columns: 85px 1fr 22px;
      gap:6px;
      align-items:center;
    }

    .row.notes { grid-template-columns: 1fr; }

    select,
    input[type="text"],
    textarea {
      background:#0d1726;
      border:1px solid #2c3a50;
      color:var(--text);
      border-radius:6px;
      box-sizing:border-box;
    }

    select {
      height:32px;
      padding:0 20px 0 6px;
      min-width:70px;
      width:auto;
    }

    input[type="text"] {
      height:32px;
      padding:0 6px;
    }

    label.done-flag {
      display:flex;
      align-items:center;
      justify-content:flex-end;
    }

    label.done-flag input {
      margin:0;
      transform: translateY(1px);
    }

    textarea.notes {
      width:100%;
      min-height:55px;
      resize:vertical;
      padding:6px;
    }

    tfoot td { padding:8px; }
  </style>
</head>
<body>
  <header>
    <div class="topline">
      <strong>Weekly Grind Admin</strong>
      <span>Week (Monday): <input id="week" type="date"></span>
      <button id="saveBtn">Save to Server</button>
      <span id="hint">Idle</span>
      <small id="lastSaved"></small>
    </div>

    <nav class="wg-admin-nav">
      <a href="/weekly-grind/view" class="wg-nav-link">Schedule View</a>
      <a href="/weekly-grind/projects" class="wg-nav-link">Projects</a>
      <a href="/weekly-grind/users" class="wg-nav-link">Users &amp; Roles</a>
      <a href="/weekly-grind/initiatives" class="wg-nav-link">Initiatives</a>
    </nav>

    <small class="note">
      To mark completion, check the box to the right of the task.
    </small>
  </header>

  <table>
    <thead><tr id="head"></tr></thead>
    <tbody id="body"></tbody>
  </table>

  <script>
    const head=document.getElementById('head');
    const body=document.getElementById('body');
    const week=document.getElementById('week');
    const saveBtn=document.getElementById('saveBtn');
    const hint=document.getElementById('hint');
    const lastSaved=document.getElementById('lastSaved');
    const TYPES=['','IMG','Bypass','Testing','Deploy','PC-O','R/R','Other'];

    const pad2=n=>String(n).padStart(2,'0');
    const toISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    function mondayOf(iso){
      const d=new Date(`${iso}T00:00:00`);
      const w=d.getDay();
      d.setDate(d.getDate()+(w===0?-6:1-w));
      return toISO(d);
    }

    function csvEscape(v){
      if(v==null)v='';
      const s=String(v);
      return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;
    }

    function toCSV(rows){
      return rows.map(r=>r.map(csvEscape).join(',')).join('\n')+'\n';
    }

    function parseCSV(text){
      let rows=[],i=0,field='',inQ=false,row=[];
      const push=()=>{row.push(field);field='';};
      const end=()=>{rows.push(row);row=[];};
      while(i<text.length){
        const ch=text[i++];
        if(inQ){
          if(ch=='"'){
            if(text[i]=='"'){field+='"';i++;}
            else inQ=false;
          }else field+=ch;
        }else{
          if(ch=='"')inQ=true;
          else if(ch==',')push();
          else if(ch=='\n'){push();end();}
          else if(ch!='\r')field+=ch;
        }
      }
      if(field.length||row.length){push();end();}
      return rows;
    }

    function normalize(rows){
      const head=rows[0]||[];
      const idx={};
      ['week_start','tech','day','slot','type','details','notes','status'].forEach(
        k=>idx[k]=head.indexOf(k)
      );
      const out=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        if(!r||!r.length)continue;
        out.push({
          week_start:r[idx.week_start]||'',
          tech:r[idx.tech]||'',
          day:r[idx.day]||'',
          slot:r[idx.slot]||'',
          type:r[idx.type]||'',
          details:r[idx.details]||'',
          notes:r[idx.notes]||'',
          status:r[idx.status]||''
        });
      }
      return out;
    }

    async function fetchTechs(){
      try{
        const r=await fetch('/weekly-grind/techs.json',{cache:'no-store'});
        const j=await r.json();
        return Array.isArray(j.techs)?j.techs:[];
      }catch{
        return[];
      }
    }

    function dayLabels(mon){
      const d=new Date(`${mon}T00:00:00`);
      const names=['Mon','Tue','Wed','Thu','Fri'];
      const out=[];
      for(let i=0;i<5;i++){
        const dd=new Date(d);
        dd.setDate(d.getDate()+i);
        out.push({iso:toISO(dd),label:names[i]});
      }
      return out;
    }

    let DAYS=[],TECHS=[];

    function renderHeader(){
      const parts = ['<th class="sticky-left">Technician</th>'];
      DAYS.forEach(d=>{
        const md = d.iso.slice(5).replace('-','/');
        parts.push(
          `<th data-iso="${d.iso}"><div class="dayhead"><span class="dlabel">${d.label}</span><span class="dmd">${md}</span></div></th>`
        );
      });
      head.innerHTML = parts.join('');
    }

    function renderRow(tech,rows){
      const tr=document.createElement('tr');
      tr.innerHTML=
        `<td class="sticky-left"><input value="${tech}"> <button class="del">Del</button></td>`;
      tr.querySelector('.del').onclick=()=>{
        if(confirm('Remove technician row?'))tr.remove();
      };

      DAYS.forEach(d=>{
        const r1=rows.find(r=>r.tech===tech&&r.day===d.iso&&r.slot=='1')||{};
        const r2=rows.find(r=>r.tech===tech&&r.day===d.iso&&r.slot=='2')||{};
        const s1=/^(y|1|true)$/i.test(r1.status||'')?'checked':'';
        const s2=/^(y|1|true)$/i.test(r2.status||'')?'checked':'';

        const td=document.createElement('td');
        td.innerHTML=
          `<div class="cell">
             <div class="row">
               <select class="s1t">
                 ${TYPES.map(o=>`<option${o===r1.type?' selected':''}>${o}</option>`).join('')}
               </select>
               <input class="s1p" type="text" value="${(r1.details||'').replace(/"/g,'&quot;')}">
               <label class="done-flag"><input type="checkbox" class="s1done" ${s1}></label>
             </div>
             <div class="row">
               <select class="s2t">
                 ${TYPES.map(o=>`<option${o===r2.type?' selected':''}>${o}</option>`).join('')}
               </select>
               <input class="s2p" type="text" value="${(r2.details||'').replace(/"/g,'&quot;')}">
               <label class="done-flag"><input type="checkbox" class="s2done" ${s2}></label>
             </div>
             <div class="row notes">
               <textarea class="notes">${(r1.notes||r2.notes||'')}</textarea>
             </div>
           </div>`;
        tr.appendChild(td);
      });

      body.appendChild(tr);
    }

    async function load(mon){
      hint.textContent='Loading…';
      const resp=await fetch(`/weekly-grind/cantina-schedule-${mon}.csv`,{cache:'no-store'});
      const text=await resp.text();
      const rows=normalize(parseCSV(text));

      TECHS=(await fetchTechs()).slice();
      rows.forEach(r=>{
        if(r.tech&&!TECHS.includes(r.tech))TECHS.push(r.tech);
      });
      TECHS.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

      DAYS=dayLabels(mon);
      renderHeader();
      body.innerHTML='';

      TECHS.forEach(t=>renderRow(t,rows));

      const fr=document.createElement('tr');
      const fd=document.createElement('td');
      fd.colSpan=6;
      fd.innerHTML='<button id="addTech">Add Tech</button> <button id="saveBtn2">Save to Server</button>';
      fr.appendChild(fd);
      body.appendChild(fr);

      document.getElementById('addTech').onclick=()=>{
        const name=(prompt('Technician name:')||'').trim();
        if(!name)return;
        if(!TECHS.includes(name))TECHS.push(name);
        renderRow(name,[]);
      };

      document.getElementById('saveBtn2').onclick=saveNow;
      hint.textContent='Ready';
    }

    function dayIsoFromIndex(i){
      const th=head.querySelector(`th:nth-child(${i+2})`);
      return th?th.dataset.iso:'';
    }

    function gather(mon){
      const out=[["week_start","tech","day","slot","type","details","notes","status"]];
      const trs=[...body.querySelectorAll('tr')].filter(tr=>tr.querySelector('.del'));

      trs.forEach(tr=>{
        const tech=tr.querySelector('.sticky-left input')?.value?.trim()||'';
        if(!tech)return;
        const tds=tr.querySelectorAll('td');
        for(let i=1;i<tds.length;i++){
          const td=tds[i];
          const day=dayIsoFromIndex(i-1);
          const notes=td.querySelector('.notes')?.value||'';
          [
            ["s1t","s1p","s1done","1"],
            ["s2t","s2p","s2done","2"]
          ].forEach(([t,p,c,slot])=>{
            const type=td.querySelector('.'+t)?.value||'';
            const det=td.querySelector('.'+p)?.value||'';
            const done=td.querySelector('.'+c)?.checked?'Y':'';
            out.push([mon,tech,day,slot,type,det,notes,done]);
          });
        }
      });
      return out;
    }

    async function saveNow(){
      const mon=week.value;
      if(!mon){
        alert('Select a week');
        return;
      }
      const csv=toCSV(gather(mon));
      hint.textContent='Saving…';
      try{
        let r=await fetch('/weekly-grind/api/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({mondayISO:mon,csv})
        });
        if(r.ok){
          hint.textContent='Saved';
          hint.classList.add('saved');
          lastSaved.textContent='Last saved: '+new Date().toLocaleString();
        }else{
          hint.textContent='Save failed';
        }
      }catch(e){
        hint.textContent='Save failed';
      }
    }

    const todayISO=toISO(new Date());
    const monISO=mondayOf(todayISO);
    week.value=monISO;
    week.addEventListener('change',e=>load(e.target.value));
    saveBtn.addEventListener('click',saveNow);
    load(monISO);
  </script>
</body>
</html>
